# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

MulmoCast-Slides is a tool collection for converting presentation files (Keynote, PowerPoint, PDF, Marp) into MulmoScript format. MulmoScript is a JSON-based format that pairs slide content with speaker notes for automated narration and multimedia processing.

The package is distributed via npm as `mulmo-slide`.

## Key Commands

### Unified CLI (mulmo-slide)

```bash
# All commands are available via the unified CLI
mulmo-slide marp path/to/presentation.md
mulmo-slide pptx path/to/presentation.pptx
mulmo-slide pdf path/to/presentation.pdf
mulmo-slide keynote path/to/presentation.key  # macOS only
mulmo-slide movie path/to/presentation.pptx
mulmo-slide bundle path/to/presentation.pptx
mulmo-slide upload <basename>
```

### Development (yarn shortcuts)

```bash
# These are shortcuts that call the unified CLI
yarn marp path/to/presentation.md
yarn pptx path/to/presentation.pptx -g -l ja  # with LLM narration
yarn pdf path/to/presentation.pdf -g -l ja
yarn keynote path/to/presentation.key
yarn movie path/to/presentation.pptx -f -g  # force regenerate with LLM
yarn bundle path/to/presentation.pptx -f -g
yarn upload <basename>  # requires MULMO_MEDIA_API_KEY env var

# Direct CLI access
yarn cli <command> [options]
```

### Build & Test

```bash
yarn build      # Build TypeScript to lib/
yarn test       # Run tests
yarn lint       # Run linter
yarn lint:fix   # Fix lint issues
```

## Testing

Tests are located in `tests/` directory using Node.js built-in test runner.

```bash
yarn test
```

Test files follow the naming convention `test_*.ts`.

### Unit Tests (no external dependencies)

- `test_common.ts` - File type detection, basename extraction, path utilities
- `test_lang.ts` - Language validation, resolution priority (CLI > env > default)
- `test_marp_extract.ts` - Marp markdown parsing, slide extraction, speaker notes

These tests run without LLM or external tools, suitable for CI.

## Architecture

### Extractor Pattern

All extractors follow a common pattern:

1. **Input**: Accept file path as argument or prompt for file selection
2. **Extraction**: Export slides and extract speaker notes
3. **Output**: Generate MulmoScript JSON file(s)
4. **Cleanup**: Remove temporary files

### Tool Structure

- `src/cli.ts` - Unified CLI entry point (mulmo-slide command)
- `src/convert/` - TypeScript converters (marp.ts, pptx.ts, pdf.ts)
- `src/actions/` - Action scripts (movie, bundle, upload) with shared utilities
- `src/utils/` - Shared utilities (lang.ts, llm.ts, pdf.ts)
- `src/types/` - TypeScript type declarations for external modules
- `tools/keynote/` - Keynote AppleScript extractor
- `lib/` - Built TypeScript output (generated by `yarn build`), `lib/cli.js` is npm bin entry
- MulmoScript output goes to `scripts/` directory
- Movie/Bundle output goes to `output/` directory

### Platform Requirements

- **Keynote**: macOS, Keynote app, Python 3
- **Marp**: Node.js/TypeScript, @marp-team/marp-cli
- **PPTX**: Node.js, LibreOffice, ImageMagick
- **PDF**: Node.js, ImageMagick

## Internal Commands (Developer Only)

### Upload Command

Upload a generated bundle to the MulmoCast server. This is for internal use only.

```bash
yarn upload <basename>
# or
mulmo-slide upload <basename>
```

**Requirements:**
- `MULMO_MEDIA_API_KEY` environment variable must be set

**How it works:**
1. Finds the bundle directory at `output/<basename>/`
2. Reads `mulmo_view.json` from the bundle
3. Requests presigned URLs from the server
4. Uploads all files to R2 storage
5. Completes the upload on the server

**Example:**
```bash
# First, generate the bundle
yarn bundle samples/sample.pptx -g -l ja

# Then, upload it
MULMO_MEDIA_API_KEY=your-api-key yarn upload sample
```
